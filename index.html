<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireGuardian Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #d32f2f;
            --primary-dark: #b71c1c;
            --primary-light: #ff6659;
            --secondary: #455a64;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text-main: #263238;
            --text-sub: #607d8b;
            --ok: #2e7d32;
            --ok-light: #4caf50;
            --warn: #ff9800;
            --warn-light: #ffb74d;
            --danger: #c62828;
            --danger-light: #ef5350;
            --border: #e0e0e0;
            --shadow: 0 6px 20px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body { 
            margin: 0; 
            padding: 0;
            background: var(--bg); 
            color: var(--text-main); 
            line-height: 1.6;
        }

        .container { 
            max-width: 100%;
            margin: auto; 
            padding: 15px;
            padding-bottom: 80px;
        }

        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 15px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
        }
        
        .app-header h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* MODO LEITURA INDICADOR */
        .readonly-banner {
            background: #ff9800;
            color: #000;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }

        /* NAVEGAÇÃO PRINCIPAL */
        .main-nav { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .main-nav button {
            flex-shrink: 0;
            padding: 12px 16px; 
            border-radius: 10px; 
            border: none;
            cursor: pointer; 
            font-weight: 600; 
            background: #fff;
            color: var(--text-sub); 
            transition: 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 110px;
        }
        
        .main-nav button.active { 
            background: var(--primary); 
            color: #fff; 
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); 
        }

        /* ABA DE ORGANIZAÇÃO */
        .organizacao-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .org-tab {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: 0.2s;
        }
        
        .org-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .add-tab-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-sub);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .add-tab-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* BUSCA AVANÇADA */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--primary);
        }
        
        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .card {
            background: var(--card); 
            border-radius: var(--radius); 
            padding: 20px;
            box-shadow: var(--shadow); 
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .tab { 
            display: none; 
            animation: fadeIn 0.4s ease; 
        }
        
        .tab.active { 
            display: block; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* DASHBOARD */
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }
        
        .stat {
            padding: 18px 12px; 
            border-radius: 15px; 
            color: #fff; 
            text-align: center;
            cursor: pointer; 
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .stat:hover { 
            transform: scale(1.03); 
        }
        
        .stat i { 
            font-size: 1.5rem; 
            margin-bottom: 6px; 
        }
        
        .stat.total { background: linear-gradient(135deg, #455a64, #37474f); }
        .stat.ok { background: linear-gradient(135deg, var(--ok), #1b5e20); }
        .stat.warn { background: linear-gradient(135deg, var(--warn), #f57f17); }
        .stat.danger { background: linear-gradient(135deg, var(--danger), #b71c1c); }
        
        .stat strong { 
            font-size: 1.6rem; 
            display: block; 
        }

        /* FORMULÁRIO - ESTILOS ESPECÍFICOS */
        .field-group { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            margin-bottom: 15px;
        }
        
        .field-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        label { 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: var(--text-main); 
        }
        
        input, select, textarea {
            padding: 12px; 
            border-radius: 10px; 
            border: 2px solid #edf2f7;
            font-size: 0.95rem; 
            transition: 0.3s; 
            outline: none;
            width: 100%;
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
        }

        fieldset {
            border: 1px solid var(--border); 
            border-radius: 12px;
            padding: 15px; 
            margin-bottom: 18px; 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 15px;
        }
        
        legend { 
            font-weight: bold; 
            padding: 0 10px; 
            color: var(--primary);
            font-size: 0.95rem;
        }

        /* BOTÕES ESPECÍFICOS */
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-sub);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: 0.2s;
        }
        
        .btn-icon:hover {
            background: #f5f5f5;
        }
        
        .btn-icon.delete {
            color: var(--danger);
        }
        
        .btn-icon.delete:hover {
            background: #ffebee;
        }

        .btn-save {
            background: var(--primary); 
            color: #fff; 
            border: none;
            padding: 16px 30px; 
            border-radius: 12px; 
            font-weight: 600;
            cursor: pointer; 
            font-size: 1rem; 
            width: 100%; 
            margin-top: 10px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-save:hover { 
            background: var(--primary-dark); 
        }

        /* TABELA */
        .table-container { 
            overflow-x: auto; 
            margin-top: 10px;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 700px;
        }
        
        th { 
            background: #f8f9fa; 
            color: var(--text-sub); 
            text-transform: uppercase; 
            font-size: 0.7rem; 
            letter-spacing: 0.5px;
            padding: 14px 10px;
            font-weight: 600;
        }
        
        td { 
            padding: 14px 10px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        }
        
        tr:hover { 
            background: #fcfcfc; 
        }

        .status-badge {
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.7rem;
            font-weight: bold; 
            text-transform: uppercase; 
            color: #fff;
            display: inline-block;
            text-align: center;
            min-width: 100px;
        }
        
        .bg-ok { background: var(--ok); }
        .bg-warn { background: var(--warn); }
        .bg-danger { background: var(--danger); }

        .btn-del { 
            background: #ffebee; 
            color: var(--danger); 
            border: none; 
            padding: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }
        
        .btn-del:hover { 
            background: var(--danger); 
            color: #fff; 
        }

        /* COMPARTILHAMENTO */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .share-btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            background: #fff;
            color: var(--text-main);
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid var(--border);
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .share-btn.pdf { background: #f44336; color: white; border-color: #f44336; }
        .share-btn.excel { background: #0d7044; color: white; border-color: #0d7044; }
        .share-btn.csv { background: #2196f3; color: white; border-color: #2196f3; }
        .share-btn.import { background: #9c27b0; color: white; border-color: #9c27b0; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card);
            border-radius: var(--radius);
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-sub);
            cursor: pointer;
        }
        
        .file-import-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .file-import-area:hover {
            border-color: var(--primary);
            background: #fff5f5;
        }
        
        .file-import-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-sub);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cfd8dc;
        }

        /* BOTÃO FLUTUANTE PRINCIPAL */
        .floating-main-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: 0.3s;
            z-index: 1000;
        }
        
        .floating-main-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(211, 47, 47, 0.5);
        }
        
        .floating-menu {
            position: fixed;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        
        .floating-menu.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .floating-menu-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.3s;
        }
        
        .floating-menu-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        /* EQUIPAMENTO PADRÃO */
        .equipamento-item {
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
            background: white;
        }
        
        .equipamento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .equipamento-codigo {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .equipamento-desc {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        
        .equipamento-local {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        /* SHARE LINK */
        .share-link-container {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .share-link-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #c8e6c9;
            border-radius: 5px;
            margin: 10px 0;
            background: white;
        }

        /* LIXEIRA PARA TIPO DE EQUIPAMENTO - ESTILO ESPECÍFICO */
        .tipo-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .tipo-select {
            flex: 1;
        }
        
        .btn-lixeira-tipo {
            background: #ffebee;
            border: none;
            color: var(--danger);
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        
        .btn-lixeira-tipo:active {
            background: #ffcdd2;
            transform: scale(0.95);
        }

        /* LAYOUT DE ORGANIZAÇÃO POR ÁREAS - CARDS */
        .areas-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .area-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .area-header {
            background: #f5f7fa;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .area-title {
            font-weight: 600;
            color: var(--text-main);
        }
        
        .area-count {
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .area-equipamentos {
            padding: 15px;
        }
        
        .equipamento-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }
        
        .equipamento-info {
            flex: 1;
        }
        
        .equipamento-codigo {
            font-weight: bold;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .equipamento-tipo {
            font-size: 0.85rem;
            color: var(--text-sub);
        }
        
        .equipamento-local {
            font-size: 0.85rem;
            color: var(--text-main);
        }
        
        .equipamento-status {
            margin-left: 10px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 900px;
                padding: 20px;
            }
            
            .dashboard {
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
            
            fieldset {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .share-options {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .organizacao-tabs {
                flex-wrap: wrap;
            }
            
            .areas-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="readonly-banner" class="readonly-banner">
        <i class="fas fa-lock"></i> MODO VISUALIZAÇÃO (Somente Leitura)
    </div>

    <div class="app-header">
        <h1><i class="fas fa-fire-extinguisher"></i> FireGuardian Pro</h1>
        <p>Sistema de Gestão de Equipamentos de Combate a Incêndio</p>
    </div>
    
    <div class="container">
        <!-- NAVEGAÇÃO PRINCIPAL -->
        <nav class="main-nav">
            <button data-tab="dashboard" class="active">
                <i class="fas fa-home"></i> Início
            </button>
            <button data-tab="organizacao">
                <i class="fas fa-layer-group"></i> Organização
            </button>
            <button data-tab="busca">
                <i class="fas fa-search"></i> Busca
            </button>
            <button data-tab="lista">
                <i class="fas fa-fire-extinguisher"></i> Equipamentos
            </button>
            <button data-tab="cadastro">
                <i class="fas fa-plus-circle"></i> Novo
            </button>
            <button data-tab="compartilhar">
                <i class="fas fa-share-alt"></i> Relatórios
            </button>
        </nav>
        
        <!-- DASHBOARD -->
        <div id="dashboard" class="tab active">
            <div class="card">
                <h2 style="margin-top: 0; margin-bottom: 20px;">Resumo de Segurança</h2>
                
                <div class="dashboard">
                    <div class="stat total" onclick="verLista('all')">
                        <i class="fas fa-fire-extinguisher"></i>
                        <strong id="total">0</strong>
                        <span>Total</span>
                    </div>
                    <div class="stat ok" onclick="verLista('ok')">
                        <i class="fas fa-check-circle"></i>
                        <strong id="ok">0</strong>
                        <span>Conforme</span>
                    </div>
                    <div class="stat warn" onclick="verLista('warn')">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong id="warn">0</strong>
                        <span>Atenção</span>
                    </div>
                    <div class="stat danger" onclick="verLista('danger')">
                        <i class="fas fa-times-circle"></i>
                        <strong id="danger">0</strong>
                        <span>Vencidos</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Equipamentos Críticos</h3>
                    <div id="dashboard-criticos"></div>
                </div>
            </div>
        </div>
        
        <!-- ORGANIZAÇÃO POR ÁREAS -->
        <div id="organizacao" class="tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Organização por Áreas</h2>
                </div>
                
                <p style="margin-bottom: 15px; color: var(--text-sub);">
                    Visualize todos os equipamentos organizados por áreas. Clique em uma aba para filtrar.
                </p>
                
                <!-- ABAS DE ORGANIZAÇÃO -->
                <div class="organizacao-tabs" id="organizacao-tabs">
                    <div class="org-tab active" data-area="all">Todos</div>
                    <div class="org-tab" data-area="terreo">Térreo</div>
                    <div class="org-tab" data-area="1andar">1º Andar</div>
                    <div class="org-tab" data-area="2andar">2º Andar</div>
                    <button class="add-tab-btn" onclick="abrirModalNovaAba()">
                        <i class="fas fa-plus"></i> Nova Aba
                    </button>
                </div>
                
                <!-- CONTEÚDO DA ABA ATUAL - LAYOUT DE CARDS -->
                <div id="organizacao-conteudo" style="margin-top: 20px;">
                    <div class="areas-container" id="areas-container">
                        <!-- Áreas serão geradas aqui dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BUSCA AVANÇADA -->
        <div id="busca" class="tab">
            <div class="card">
                <h2 style="margin-top: 0;">Busca de Equipamentos</h2>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="busca-input" placeholder="Digite para buscar por equipamento, local, código...">
                    <button class="search-btn" onclick="realizarBusca()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Equipamento</th>
                                <th>Tipo</th>
                                <th>Local</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="busca-tbody"></tbody>
                    </table>
                </div>
                
                <div id="busca-vazia" class="empty-state" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>Nenhum resultado encontrado</h3>
                    <p>Tente alterar os termos da busca</p>
                </div>
            </div>
        </div>
        
        <!-- LISTA DE EQUIPAMENTOS -->
        <div id="lista" class="tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Equipamentos Cadastrados</h2>
                    <span id="filtro-ativo"></span>
                </div>
                
                <div id="filtro-info-container"></div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Código</th>
                                <th>Equipamento</th>
                                <th>Local</th>
                                <th>Vencimento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
                
                <div id="lista-vazia" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>Nenhum equipamento</h3>
                    <p>Cadastre seu primeiro equipamento.</p>
                </div>
            </div>
        </div>
        
        <!-- CADASTRO DE EQUIPAMENTO -->
        <div id="cadastro" class="tab">
            <div class="card">
                <h2 style="margin-top: 0;">Cadastro de Equipamento</h2>
                
                <div class="field-group" style="background: #fafafa; padding: 10px; border-radius: 8px;">
                    <label>Usar modelo existente</label>
                    <div class="field-row">
                        <select id="modelo" style="flex: 1;">
                            <option value="">-- Selecione --</option>
                        </select>
                        <button type="button" class="btn-icon delete" onclick="limparModelo()" title="Limpar modelo" id="btn-limpar-modelo" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <form id="form">
                    <fieldset>
                        <legend>Informações do Equipamento</legend>
                        
                        <div class="field-group">
                            <label>Tipo de Equipamento *</label>
                            <div class="field-row">
                                <input type="text" id="tipo" list="tipos-lista" required placeholder="Ex: Extintor, Mangueira, Hidrante...">
                                <datalist id="tipos-lista">
                                    <!-- Opções serão preenchidas dinamicamente -->
                                </datalist>
                                <button type="button" class="btn-lixeira-tipo" onclick="excluirTipoAtual()" title="Excluir tipo selecionado" id="btn-excluir-tipo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <small style="font-size: 0.75rem; color: #888;">Digite livremente ou selecione da lista. Clique na lixeira para excluir o tipo selecionado da lista.</small>
                        </div>
                        
                        <div class="field-group" id="chave-storz-container" style="display: none;">
                            <label>Chave Storz</label>
                            <select id="chave-storz">
                                <option value="Não">Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                        </div>
                        
                        <div class="field-group">
                            <label>Código/TAG *</label>
                            <input type="text" id="codigo" required placeholder="Ex: AK-10">
                        </div>
                        
                        <div class="field-group">
                            <label>Descrição *</label>
                            <input type="text" id="descricao" required placeholder="Ex: Extintor Pó BC 04 KG">
                        </div>
                        
                        <div class="field-group">
                            <label>Área *</label>
                            <input type="text" id="area" required placeholder="Ex: Estacionamento 3° Andar">
                        </div>
                        
                        <div class="field-group">
                            <label>Local Específico *</label>
                            <input type="text" id="local" required placeholder="Ex: Acesso Elevador">
                        </div>
                    </fieldset>
                    
                    <fieldset>
                        <legend>Datas</legend>
                        
                        <div class="field-group">
                            <label>Última Inspeção *</label>
                            <input type="date" id="ultima" required>
                        </div>
                        
                        <div class="field-group">
                            <label>Próxima Inspeção/Validade *</label>
                            <input type="date" id="validade" required>
                        </div>
                    </fieldset>
                    
                    <div class="field-group">
                        <label>Observações</label>
                        <textarea id="obs" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i> SALVAR EQUIPAMENTO
                    </button>
                </form>
            </div>
        </div>
        
        <!-- COMPARTILHAR ACESSO - MANTIDO COMO ESTÁ -->
        <div id="compartilhar" class="tab">
            <div class="card">
                <h2 style="margin-top: 0;">Relatórios e Compartilhamento</h2>
                
                <div class="share-options">
                    <button class="share-btn pdf" onclick="gerarPDF()">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                    </button>
                    <button class="share-btn excel" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span>Excel</span>
                    </button>
                    <button class="share-btn csv" onclick="exportarCSV()" style="display: none;">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV</span>
                    </button>
                    <button class="share-btn import" onclick="abrirModalImportacao()" style="display: none;">
                        <i class="fas fa-file-import"></i>
                        <span>Importar</span>
                    </button>
                </div>
                
                <div style="margin-top: 25px;">
                    <h3>Compartilhar Acesso</h3>
                    <div class="share-link-container">
                        <p>Gere um link de visualização para compartilhar os equipamentos:</p>
                        <div style="margin-bottom: 10px;">
                            <label>Duração do Link:</label>
                            <select id="duracaoLink" style="width: 100%; padding: 8px; border-radius: 5px; margin-top: 5px;">
                                <option value="1">1 Hora</option>
                                <option value="5">5 Horas</option>
                                <option value="24">1 Dia</option>
                            </select>
                        </div>
                        <button onclick="gerarLinkCompartilhamento()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
                            <i class="fas fa-link"></i> Gerar Link de Compartilhamento
                        </button>
                        <div id="share-link-result" style="margin-top: 15px; padding: 10px; background: #fff; border: 1px dashed #ccc; border-radius: 5px; display: none;">
                            <strong>Link temporário:</strong><br>
                            <span id="url-texto" style="color: blue; word-break: break-all;"></span>
                            <p style="font-size: 0.7rem; color: #d32f2f; margin-top:5px;">
                                *Nota: Como este sistema não possui servidor online, este link funcionará apenas para simular o modo "Apenas Leitura" neste dispositivo.
                            </p>
                            <button onclick="copiarLink()" style="margin-top:10px; padding:5px 10px; border:1px solid #ccc; background:#fff; border-radius:4px; width: 100%;">
                                <i class="fas fa-copy"></i> Copiar Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- BOTÃO FLUTUANTE PRINCIPAL -->
    <button class="floating-main-btn" onclick="toggleFloatingMenu()" id="floating-main-btn">
        <i class="fas fa-plus"></i>
    </button>
    
    <div class="floating-menu" id="floating-menu">
        <button class="floating-menu-btn" onclick="abrirModalImportacao()" title="Importar" style="display: none;">
            <i class="fas fa-file-import"></i>
        </button>
        <button class="floating-menu-btn" onclick="openTab('cadastro')" title="Novo">
            <i class="fas fa-plus"></i>
        </button>
        <button class="floating-menu-btn" onclick="gerarPDF()" title="PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
    </div>
    
    <!-- MODAL: NOVA ABA -->
    <div id="modal-nova-aba" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Aba de Organização</h3>
                <button class="modal-close" onclick="fecharModalNovaAba()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="field-group">
                <label>Nome da Aba</label>
                <input type="text" id="nova-aba-nome" placeholder="Ex: 3º Andar">
            </div>
            
            <div class="field-group">
                <label>Área (opcional)</label>
                <input type="text" id="nova-aba-area" placeholder="Ex: Estacionamento">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="adicionarNovaAba()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Adicionar
                </button>
                <button onclick="fecharModalNovaAba()" style="flex: 1; padding: 12px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EDITAR TIPOS -->
    <div id="modal-editar-tipos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Tipos de Equipamento</h3>
                <button class="modal-close" onclick="fecharModalEditarTipos()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="tipos-lista">
                <div class="field-group">
                    <label>Tipos cadastrados</label>
                    <div id="tipos-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                        <!-- Tipos serão carregados aqui -->
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Adicionar novo tipo</label>
                    <div class="field-row">
                        <input type="text" id="novo-tipo" placeholder="Ex: Mangueira de Incêndio">
                        <button onclick="adicionarTipo()" style="padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="fecharModalEditarTipos()" style="flex: 1; padding: 12px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: IMPORTAR -->
    <div id="modal-import" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Importar Dados</h3>
                <button class="modal-close" onclick="fecharModalImportacao()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <p>Importe dados de planilhas Excel, CSV ou arquivos JSON.</p>
            
            <div class="file-import-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Clique ou arraste arquivos aqui</h4>
                <p>Suporta: Excel (.xlsx, .xls), CSV (.csv), JSON (.json)</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv,.json">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="downloadModeloExcel()" style="flex: 1; padding: 12px; background: #0d7044; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-download"></i> Baixar Modelo
                </button>
                <button onclick="fecharModalImportacao()" style="flex: 1; padding: 12px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dados da aplicação
        let data = JSON.parse(localStorage.getItem('fire_db') || '[]');
        let modelos = JSON.parse(localStorage.getItem('fire_models') || '[]');
        let tiposEquipamento = JSON.parse(localStorage.getItem('fire_types') || '["Extintor", "Mangueira", "Hidrante", "Alarme", "Sinalização", "Luz de Emergência"]');
        let abasOrganizacao = JSON.parse(localStorage.getItem('fire_abas') || '[{"id":"all","nome":"Todos"},{"id":"terreo","nome":"Térreo"},{"id":"1andar","nome":"1º Andar"},{"id":"2andar","nome":"2º Andar"}]');
        let filtroAtual = 'all';
        let abaOrganizacaoAtual = 'all';
        let shareLinks = JSON.parse(localStorage.getItem('fire_share_links') || '[]');
        let modoLeitura = false;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            const proximoMes = new Date();
            proximoMes.setMonth(hoje.getMonth() + 1);
            
            // Definir datas padrão
            document.getElementById('ultima').value = hoje.toISOString().split('T')[0];
            document.getElementById('validade').value = proximoMes.toISOString().split('T')[0];
            
            // Configurar inputs
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            
            // Carregar tipos no datalist
            carregarTiposDatalist();
            
            // Configurar detecção de tipo Mangueira
            document.getElementById('tipo').addEventListener('input', function() {
                const isMangueira = this.value.toLowerCase().includes('mangueira');
                document.getElementById('chave-storz-container').style.display = isMangueira ? 'block' : 'none';
            });
            
            // Renderizar abas de organização
            renderizarAbasOrganizacao();
            
            // Renderizar dados
            render();
            
            // Verificar se está em modo visualização compartilhada
            verificarModoCompartilhado();
            
            // Configurar eventos do formulário
            document.getElementById('modelo').addEventListener('change', carregarModeloSelecionado);
            
            // Verificar modo leitura
            verificarModoLeitura();
        });
        
        // Verificar modo leitura
        function verificarModoLeitura() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'readonly') {
                modoLeitura = true;
                
                // Aplicar UI de leitura
                document.getElementById('readonly-banner').style.display = 'block';
                document.querySelector('.main-nav button[data-tab="cadastro"]').classList.add('hidden');
                
                // Remove botões de ação
                const btns = document.querySelectorAll('.btn-save, .btn-del, .floating-main-btn, .floating-menu-btn');
                btns.forEach(b => b.classList.add('hidden'));
                
                // Oculta botões de exclusão
                document.querySelectorAll('.btn-lixeira-tipo').forEach(b => b.classList.add('hidden'));
                
                // Força ir para dashboard
                openTab('dashboard');
                
                alert("Você está em modo de VISUALIZAÇÃO. Edições estão desativadas.");
            }
        }
        
        // Gerenciamento de abas
        function openTab(tabId) {
            if (modoLeitura && tabId === 'cadastro') {
                return; // Não permite acessar cadastro em modo leitura
            }
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.main-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.main-nav button[data-tab="${tabId}"]`).classList.add('active');
            
            // Se for a aba de organização, renderizar conteúdo
            if (tabId === 'organizacao') {
                renderizarConteudoOrganizacaoCards();
            }
            
            // Fechar menu flutuante
            document.getElementById('floating-menu').classList.remove('active');
        }
        
        document.querySelectorAll('.main-nav button').forEach(b => {
            b.addEventListener('click', () => openTab(b.dataset.tab));
        });
        
        // Menu flutuante
        function toggleFloatingMenu() {
            const menu = document.getElementById('floating-menu');
            menu.classList.toggle('active');
        }
        
        // Fechar menu flutuante ao clicar fora
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('floating-menu');
            const btn = document.getElementById('floating-main-btn');
            
            if (!menu.contains(e.target) && !btn.contains(e.target) && menu.classList.contains('active')) {
                menu.classList.remove('active');
            }
        });
        
        // Status dos equipamentos
        function getStatus(item) {
            if (!item.validade) return { label: 'Sem data', class: 'bg-warn', code: 'warn', dias: 999 };
            
            const hoje = new Date();
            const venc = new Date(item.validade);
            const diffDias = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
            
            if (diffDias < 0) return { label: 'Vencido', class: 'bg-danger', code: 'danger', dias: diffDias };
            if (diffDias <= 30) return { label: 'Atenção', class: 'bg-warn', code: 'warn', dias: diffDias };
            return { label: 'Conforme', class: 'bg-ok', code: 'ok', dias: diffDias };
        }
        
        // Renderizar dados principais
        function render() {
            const tbody = document.getElementById('tbody');
            const listaVazia = document.getElementById('lista-vazia');
            const filtroInfo = document.getElementById('filtro-info-container');
            
            tbody.innerHTML = '';
            filtroInfo.innerHTML = '';
            
            let counts = { total: 0, ok: 0, warn: 0, danger: 0 };
            
            // Contar e filtrar
            const dadosFiltrados = data.filter(item => {
                const s = getStatus(item);
                counts.total++;
                counts[s.code]++;
                
                if (filtroAtual === 'all' || filtroAtual === s.code) {
                    return true;
                }
                return false;
            });
            
            // Atualizar dashboard
            document.getElementById('total').textContent = counts.total;
            document.getElementById('ok').textContent = counts.ok;
            document.getElementById('warn').textContent = counts.warn;
            document.getElementById('danger').textContent = counts.danger;
            
            // Atualizar dashboard críticos
            atualizarDashboardCriticos();
            
            // Mostrar filtro ativo
            if (filtroAtual !== 'all') {
                const labels = { ok: 'Conforme', warn: 'Atenção', danger: 'Vencido' };
                filtroInfo.innerHTML = `
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between;">
                        <span>Filtro: <strong>${labels[filtroAtual]}</strong> (${dadosFiltrados.length} equipamentos)</span>
                        <button onclick="verLista('all')" style="background: none; border: none; color: #1565c0; cursor: pointer;">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                `;
            }
            
            // Preencher tabela
            dadosFiltrados.forEach((item, index) => {
                const s = getStatus(item);
                const dataVenc = item.validade ? new Date(item.validade) : new Date();
                const hoje = new Date();
                const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                
                let diasTexto = '';
                if (diffDias < 0) {
                    diasTexto = `<span style="color: #d32f2f;">${Math.abs(diffDias)} dias atrás</span>`;
                } else if (diffDias <= 30) {
                    diasTexto = `<span style="color: #ff9800;">${diffDias} dias</span>`;
                } else {
                    diasTexto = `<span style="color: #2e7d32;">${diffDias} dias</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td><span class="status-badge ${s.class}">${s.label}</span></td>
                        <td><strong>${item.codigo || 'N/A'}</strong></td>
                        <td>
                            <strong>${item.descricao}</strong><br>
                            <small>${item.tipo}${item.chaveStorz ? ' - Chave Storz: ' + item.chaveStorz : ''}</small>
                        </td>
                        <td>${item.area}<br><small>${item.local}</small></td>
                        <td>
                            ${item.validade ? item.validade.split('-').reverse().join('/') : 'N/A'}<br>
                            <small>${diasTexto}</small>
                        </td>
                        <td>
                            ${!modoLeitura ? `<button class="btn-del" onclick="excluirEquipamento(${index})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            // Lista vazia
            if (data.length === 0) {
                listaVazia.style.display = 'block';
            } else {
                listaVazia.style.display = 'none';
            }
            
            // Atualizar modelos
            const selectModelo = document.getElementById('modelo');
            selectModelo.innerHTML = '<option value="">-- Selecione --</option>';
            
            // Criar modelos baseados nos últimos 10 cadastros únicos por descrição
            const unicos = [...new Map(data.map(item => [item['descricao'], item])).values()].slice(-10);
            
            unicos.forEach((item, i) => {
                selectModelo.innerHTML += `<option value="${i}">${item.descricao} (${item.local})</option>`;
            });
            
            // Atualizar busca se estiver ativa
            if (document.getElementById('busca').classList.contains('active')) {
                realizarBusca();
            }
        }
        
        // Atualizar dashboard críticos
        function atualizarDashboardCriticos() {
            const container = document.getElementById('dashboard-criticos');
            const equipamentosCriticos = data.filter(item => {
                const s = getStatus(item);
                return s.code === 'danger' || (s.code === 'warn' && s.dias <= 15);
            }).slice(0, 5);
            
            if (equipamentosCriticos.length === 0) {
                container.innerHTML = `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <i class="fas fa-check-circle" style="color: #2e7d32; font-size: 1.5rem; margin-bottom: 10px;"></i>
                        <p>Todos os equipamentos estão em conformidade!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            equipamentosCriticos.forEach(item => {
                const s = getStatus(item);
                html += `
                    <div class="equipamento-item">
                        <div class="equipamento-header">
                            <div class="equipamento-codigo">${item.codigo || 'N/A'}</div>
                            <span class="status-badge ${s.class}">${s.label}</span>
                        </div>
                        <div class="equipamento-desc">${item.descricao}${item.chaveStorz ? ' - Chave Storz: ' + item.chaveStorz : ''}</div>
                        <div class="equipamento-local">${item.area} - ${item.local}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Funções de navegação
        function verLista(status) {
            filtroAtual = status;
            render();
            openTab('lista');
        }
        
        function excluirEquipamento(index) {
            if (modoLeitura) {
                alert("Modo leitura: Ação não permitida.");
                return;
            }
            
            if (confirm('Excluir este equipamento?')) {
                data.splice(index, 1);
                salvarDados();
            }
        }
        
        // Carregar modelo selecionado
        function carregarModeloSelecionado() {
            const select = document.getElementById('modelo');
            const btnLimpar = document.getElementById('btn-limpar-modelo');
            const index = select.value;
            
            if (index !== "") {
                btnLimpar.style.display = 'block';
                
                // Criar lista de modelos únicos
                const unicos = [...new Map(data.map(item => [item['descricao'], item])).values()].slice(-10);
                const modelo = unicos[index];
                
                if (modelo) {
                    document.getElementById('tipo').value = modelo.tipo;
                    document.getElementById('codigo').value = modelo.codigo || '';
                    document.getElementById('descricao').value = modelo.descricao;
                    document.getElementById('area').value = modelo.area;
                    document.getElementById('local').value = modelo.local;
                    document.getElementById('ultima').value = modelo.ultima || '';
                    document.getElementById('validade').value = modelo.validade || '';
                    document.getElementById('obs').value = modelo.obs || '';
                    
                    // Configurar chave Storz se for mangueira
                    const isMangueira = modelo.tipo.toLowerCase().includes('mangueira');
                    document.getElementById('chave-storz-container').style.display = isMangueira ? 'block' : 'none';
                    if (modelo.chaveStorz) {
                        document.getElementById('chave-storz').value = modelo.chaveStorz;
                    }
                }
            } else {
                btnLimpar.style.display = 'none';
            }
        }
        
        function limparModelo() {
            document.getElementById('modelo').value = "";
            document.getElementById('btn-limpar-modelo').style.display = 'none';
            document.getElementById('form').reset();
            
            // Resetar datas
            const hoje = new Date();
            const proximoMes = new Date();
            proximoMes.setMonth(hoje.getMonth() + 1);
            
            document.getElementById('ultima').value = hoje.toISOString().split('T')[0];
            document.getElementById('validade').value = proximoMes.toISOString().split('T')[0];
            
            // Ocultar chave Storz
            document.getElementById('chave-storz-container').style.display = 'none';
        }
        
        // Salvar equipamento
        document.getElementById('form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (modoLeitura) {
                alert("Modo leitura: Ação não permitida.");
                return;
            }
            
            const novoEquipamento = {
                id: Date.now(),
                tipo: document.getElementById('tipo').value,
                codigo: document.getElementById('codigo').value.toUpperCase(),
                descricao: document.getElementById('descricao').value.toUpperCase(),
                area: document.getElementById('area').value.toUpperCase(),
                local: document.getElementById('local').value.toUpperCase(),
                ultima: document.getElementById('ultima').value,
                validade: document.getElementById('validade').value,
                obs: document.getElementById('obs').value
            };
            
            // Adicionar chave Storz se for mangueira
            const isMangueira = novoEquipamento.tipo.toLowerCase().includes('mangueira');
            if (isMangueira) {
                novoEquipamento.chaveStorz = document.getElementById('chave-storz').value;
            }
            
            // Adicionar tipo à lista se não existir
            if (novoEquipamento.tipo && !tiposEquipamento.includes(novoEquipamento.tipo)) {
                tiposEquipamento.push(novoEquipamento.tipo);
                carregarTiposDatalist();
            }
            
            data.push(novoEquipamento);
            
            salvarDados();
            this.reset();
            
            // Resetar datas
            const hoje = new Date();
            const proximoMes = new Date();
            proximoMes.setMonth(hoje.getMonth() + 1);
            
            document.getElementById('ultima').value = hoje.toISOString().split('T')[0];
            document.getElementById('validade').value = proximoMes.toISOString().split('T')[0];
            
            // Ocultar chave Storz
            document.getElementById('chave-storz-container').style.display = 'none';
            
            alert('Equipamento salvo com sucesso!');
            openTab('lista');
        });
        
        function salvarDados() {
            localStorage.setItem('fire_db', JSON.stringify(data));
            localStorage.setItem('fire_types', JSON.stringify(tiposEquipamento));
            localStorage.setItem('fire_abas', JSON.stringify(abasOrganizacao));
            localStorage.setItem('fire_share_links', JSON.stringify(shareLinks));
            render();
        }
        
        // BUSCA AVANÇADA
        function realizarBusca() {
            const termo = document.getElementById('busca-input').value.toLowerCase();
            const tbody = document.getElementById('busca-tbody');
            const vazio = document.getElementById('busca-vazia');
            
            tbody.innerHTML = '';
            
            if (!termo) {
                vazio.style.display = 'block';
                vazio.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>Digite para buscar</h3>
                    <p>Busque por código, descrição, tipo ou local</p>
                `;
                return;
            }
            
            const resultados = data.filter(item => 
                (item.codigo && item.codigo.toLowerCase().includes(termo)) ||
                item.descricao.toLowerCase().includes(termo) ||
                item.tipo.toLowerCase().includes(termo) ||
                item.area.toLowerCase().includes(termo) ||
                item.local.toLowerCase().includes(termo) ||
                (item.obs && item.obs.toLowerCase().includes(termo))
            );
            
            if (resultados.length === 0) {
                vazio.style.display = 'block';
                vazio.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>Nenhum resultado encontrado</h3>
                    <p>Tente alterar os termos da busca</p>
                `;
                return;
            }
            
            vazio.style.display = 'none';
            
            resultados.forEach(item => {
                const s = getStatus(item);
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${item.codigo || 'N/A'}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.tipo}${item.chaveStorz ? ' - Chave Storz: ' + item.chaveStorz : ''}</td>
                        <td>${item.area} - ${item.local}</td>
                        <td><span class="status-badge ${s.class}">${s.label}</span></td>
                    </tr>
                `;
            });
        }
        
        // ORGANIZAÇÃO POR ABAS - CARDS
        function renderizarAbasOrganizacao() {
            const container = document.getElementById('organizacao-tabs');
            container.innerHTML = '';
            
            abasOrganizacao.forEach(aba => {
                const btn = document.createElement('div');
                btn.className = `org-tab ${aba.id === abaOrganizacaoAtual ? 'active' : ''}`;
                btn.dataset.area = aba.id;
                btn.textContent = aba.nome;
                btn.onclick = () => {
                    document.querySelectorAll('.org-tab').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    abaOrganizacaoAtual = aba.id;
                    renderizarConteudoOrganizacaoCards();
                };
                container.appendChild(btn);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-tab-btn';
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Nova Aba';
            addBtn.onclick = abrirModalNovaAba;
            container.appendChild(addBtn);
        }
        
        function renderizarConteudoOrganizacaoCards() {
            const container = document.getElementById('areas-container');
            container.innerHTML = '';
            
            let equipamentosFiltrados = data;
            
            if (abaOrganizacaoAtual !== 'all') {
                const aba = abasOrganizacao.find(a => a.id === abaOrganizacaoAtual);
                if (aba) {
                    equipamentosFiltrados = data.filter(item => 
                        item.area.toLowerCase().includes(aba.nome.toLowerCase()) ||
                        item.local.toLowerCase().includes(aba.nome.toLowerCase())
                    );
                }
            }
            
            if (equipamentosFiltrados.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: #cfd8dc; margin-bottom: 15px;"></i>
                        <h3 style="color: var(--text-sub);">Nenhum equipamento nesta área</h3>
                    </div>
                `;
                return;
            }
            
            // Agrupar equipamentos por área
            const areas = {};
            equipamentosFiltrados.forEach(item => {
                if (!areas[item.area]) {
                    areas[item.area] = [];
                }
                areas[item.area].push(item);
            });
            
            // Criar cards para cada área
            Object.keys(areas).forEach(area => {
                const areaDiv = document.createElement('div');
                areaDiv.className = 'area-card';
                
                const header = document.createElement('div');
                header.className = 'area-header';
                header.innerHTML = `
                    <div class="area-title">${area}</div>
                    <div class="area-count">${areas[area].length} equipamentos</div>
                `;
                
                const equipamentosDiv = document.createElement('div');
                equipamentosDiv.className = 'area-equipamentos';
                
                areas[area].forEach((item, index) => {
                    const s = getStatus(item);
                    const dataVenc = item.validade ? new Date(item.validade) : new Date();
                    const hoje = new Date();
                    const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                    
                    let diasTexto = '';
                    if (diffDias < 0) {
                        diasTexto = `${Math.abs(diffDias)} dias atrás`;
                    } else if (diffDias <= 30) {
                        diasTexto = `${diffDias} dias`;
                    } else {
                        diasTexto = `${diffDias} dias`;
                    }
                    
                    const equipamentoDiv = document.createElement('div');
                    equipamentoDiv.className = 'equipamento-card';
                    equipamentoDiv.innerHTML = `
                        <div class="equipamento-info">
                            <div class="equipamento-codigo">${item.codigo || 'N/A'}</div>
                            <div class="equipamento-tipo">${item.tipo}${item.chaveStorz ? ' - Chave Storz: ' + item.chaveStorz : ''}</div>
                            <div class="equipamento-desc">${item.descricao}</div>
                            <div class="equipamento-local">${item.local} | Venc: ${item.validade ? item.validade.split('-').reverse().join('/') : 'N/A'}</div>
                        </div>
                        <div class="equipamento-status">
                            <span class="status-badge ${s.class}">${s.label}</span>
                            ${!modoLeitura ? `<button class="btn-del" onclick="excluirEquipamento(${data.indexOf(item)})" title="Excluir" style="margin-top: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    `;
                    
                    equipamentosDiv.appendChild(equipamentoDiv);
                });
                
                areaDiv.appendChild(header);
                areaDiv.appendChild(equipamentosDiv);
                container.appendChild(areaDiv);
            });
        }
        
        // MODAL: NOVA ABA
        function abrirModalNovaAba() {
            if (modoLeitura) {
                alert("Modo leitura: Ação não permitida.");
                return;
            }
            document.getElementById('modal-nova-aba').classList.add('active');
        }
        
        function fecharModalNovaAba() {
            document.getElementById('modal-nova-aba').classList.remove('active');
            document.getElementById('nova-aba-nome').value = '';
            document.getElementById('nova-aba-area').value = '';
        }
        
        function adicionarNovaAba() {
            const nome = document.getElementById('nova-aba-nome').value.trim();
            const area = document.getElementById('nova-aba-area').value.trim();
            
            if (!nome) {
                alert('Digite um nome para a aba');
                return;
            }
            
            const id = nome.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            
            if (abasOrganizacao.some(aba => aba.id === id)) {
                alert('Já existe uma aba com esse nome');
                return;
            }
            
            abasOrganizacao.push({
                id: id,
                nome: nome,
                area: area
            });
            
            salvarDados();
            renderizarAbasOrganizacao();
            fecharModalNovaAba();
            
            // Ativar a nova aba
            abaOrganizacaoAtual = id;
            document.querySelectorAll('.org-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.org-tab[data-area="${id}"]`).classList.add('active');
            renderizarConteudoOrganizacaoCards();
        }
        
        // TIPOS DE EQUIPAMENTO - COM LIXEIRA
        function carregarTiposDatalist() {
            const datalist = document.getElementById('tipos-lista');
            datalist.innerHTML = '';
            
            tiposEquipamento.forEach(tipo => {
                datalist.innerHTML += `<option value="${tipo}">`;
            });
        }
        
        function excluirTipoAtual() {
            if (modoLeitura) {
                alert("Modo leitura: Ação não permitida.");
                return;
            }
            
            const input = document.getElementById('tipo');
            const tipoAtual = input.value;

            if (!tipoAtual) {
                alert('Selecione um tipo para excluir.');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir o tipo "${tipoAtual}" da lista de seleções?`)) {
                const index = tiposEquipamento.indexOf(tipoAtual);
                if (index > -1) {
                    tiposEquipamento.splice(index, 1);
                    salvarTipos();
                    input.value = "";
                    carregarTiposDatalist();
                }
            }
        }
        
        function salvarTipos() {
            localStorage.setItem('fire_types', JSON.stringify(tiposEquipamento));
            carregarTiposDatalist();
        }
        
        // MODAL: EDITAR TIPOS
        function abrirModalEditarTipos() {
            if (modoLeitura) {
                alert("Modo leitura: Ação não permitida.");
                return;
            }
            
            const container = document.getElementById('tipos-container');
            container.innerHTML = '';
            
            tiposEquipamento.forEach((tipo, index) => {
                const div = document.createElement('div');
                div.className = 'field-row';
                div.style.padding = '8px';
                div.style.borderBottom = '1px solid #eee';
                div.innerHTML = `
                    <span style="flex: 1;">${tipo}</span>
                    <button class="btn-icon delete" onclick="removerTipo(${index})" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                container.appendChild(div);
            });
            
            document.getElementById('modal-editar-tipos').classList.add('active');
        }
        
        function fecharModalEditarTipos() {
            document.getElementById('modal-editar-tipos').classList.remove('active');
            document.getElementById('novo-tipo').value = '';
        }
        
        function adicionarTipo() {
            const novoTipo = document.getElementById('novo-tipo').value.trim().toUpperCase();
            
            if (!novoTipo) {
                alert('Digite um tipo de equipamento');
                return;
            }
            
            if (tiposEquipamento.includes(novoTipo)) {
                alert('Este tipo já existe');
                return;
            }
            
            tiposEquipamento.push(novoTipo);
            salvarTipos();
            carregarTiposDatalist();
            abrirModalEditarTipos(); // Recarregar a lista
            document.getElementById('novo-tipo').value = '';
        }
        
        function removerTipo(index) {
            if (confirm(`Excluir o tipo "${tiposEquipamento[index]}"?`)) {
                tiposEquipamento.splice(index, 1);
                salvarTipos();
                carregarTiposDatalist();
                abrirModalEditarTipos(); // Recarregar a lista
            }
        }
        
        // COMPARTILHAMENTO
        function gerarLinkCompartilhamento() {
            const duracao = document.getElementById('duracaoLink').value;
            const timestamp = Date.now();
            // Simulação de Token
            const token = btoa(JSON.stringify({ exp: timestamp + (duracao * 3600000) }));
            
            // Criando URL com hash parameters
            const url = `${window.location.origin}${window.location.pathname}?mode=readonly&token=${token}`;
            
            document.getElementById('share-link-result').style.display = 'block';
            document.getElementById('url-texto').innerText = url;
        }
        
        function copiarLink() {
            const url = document.getElementById('url-texto').innerText;
            navigator.clipboard.writeText(url).then(() => alert("Link copiado!"));
        }
        
        function verificarModoCompartilhado() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token && urlParams.get('mode') === 'readonly') {
                try {
                    const tokenData = JSON.parse(atob(token));
                    if (tokenData.exp > Date.now()) {
                        // Token válido
                        modoLeitura = true;
                        verificarModoLeitura();
                    }
                } catch (e) {
                    console.log('Token inválido');
                }
            }
        }
        
        // FUNÇÕES DE EXPORTAÇÃO
        function gerarPDF() {
            if (data.length === 0) {
                alert('Não há dados para gerar PDF!');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text("Relatório de Inventário - FireGuardian", 14, 20);
                
                const tableData = data.map(item => [
                    item.codigo || '',
                    item.tipo + (item.chaveStorz ? ' - Chave Storz: ' + item.chaveStorz : ''),
                    item.descricao,
                    `${item.area} - ${item.local}`,
                    item.validade ? item.validade.split('-').reverse().join('/') : ''
                ]);

                doc.autoTable({
                    head: [['TAG', 'Tipo', 'Descrição', 'Local', 'Validade']],
                    body: tableData,
                    startY: 30,
                });

                doc.save("FireGuardian_Relatorio.pdf");
                alert(`PDF gerado com ${data.length} equipamentos!`);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Verifique se as bibliotecas estão carregadas.');
            }
        }
        
        function exportarExcel() {
            if (data.length === 0) {
                alert('Não há dados para exportar!');
                return;
            }
            
            try {
                const dadosFormatados = data.map(item => {
                    const s = getStatus(item);
                    return {
                        'Código': item.codigo || '',
                        'Tipo': item.tipo,
                        'Chave Storz': item.chaveStorz || '',
                        'Descrição': item.descricao,
                        'Área': item.area,
                        'Local': item.local,
                        'Última Inspeção': item.ultima || '',
                        'Próxima Inspeção': item.validade || '',
                        'Status': s.label,
                        'Observações': item.obs || ''
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(dadosFormatados);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Equipamentos");
                XLSX.writeFile(wb, `equipamentos_fireguardian_${new Date().toISOString().slice(0,10)}.xlsx`);
                alert(`Excel exportado com ${data.length} equipamentos!`);
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                alert('Erro ao exportar Excel.');
            }
        }
        
        function exportarCSV() {
            if (data.length === 0) {
                alert('Não há dados para exportar!');
                return;
            }
            
            try {
                let csv = 'Código;Tipo;Chave Storz;Descrição;Área;Local;Última Inspeção;Próxima Inspeção;Observações\n';
                data.forEach(item => {
                    csv += `"${item.codigo || ''}";"${item.tipo}";"${item.chaveStorz || ''}";"${item.descricao}";"${item.area}";"${item.local}";"${item.ultima || ''}";"${item.validade || ''}";"${item.obs || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `equipamentos_fireguardian_${new Date().toISOString().slice(0,10)}.csv`);
                alert(`CSV exportado com ${data.length} equipamentos!`);
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                alert('Erro ao exportar CSV.');
            }
        }
        
        // Funções de importação (ocultas conforme solicitado)
        function abrirModalImportacao() {
            // Esta função está oculta conforme solicitado
            return;
        }
        
        function fecharModalImportacao() {
            // Esta função está oculta conforme solicitado
            return;
        }
        
        function handleFileImport(event) {
            // Esta função está oculta conforme solicitado
            return;
        }
        
        function formatarData(dataStr) {
            // Esta função está oculta conforme solicitado
            return dataStr;
        }
        
        function downloadModeloExcel() {
            // Esta função está oculta conforme solicitado
            return;
        }
        
        // Fechar modais ao clicar fora
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
                                </html>
